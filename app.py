import streamlit as st
import requests
import numpy as np

st.set_page_config(page_title="Dota 2 Deep Analyst", page_icon="üìà", layout="wide")

class AdvancedOracle:
    def __init__(self):
        self.api_url = "https://api.opendota.com/api/"
        
    @st.cache_data(ttl=3600)
    def get_pro_teams(_self):
        try:
            res = requests.get(f"{_self.api_url}teams", timeout=10).json()
            return sorted([t for t in res if t.get('rating') and t.get('name')], 
                          key=lambda x: x['rating'], reverse=True)
        except: return []

    def get_detailed_prediction(self, t1, t2):
        # –†–∞—Å—á–µ—Ç —à–∞–Ω—Å–æ–≤ –ø–æ —Å–∏—Å—Ç–µ–º–µ Elo
        prob = 1 / (1 + 10 ** ((t2['rating'] - t1['rating']) / 400))
        
        # –°–±–æ—Ä –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
        winrate_1 = t1['wins'] / (t1['wins'] + t1['losses']) if (t1['wins'] + t1['losses']) > 0 else 0
        winrate_2 = t2['wins'] / (t2['wins'] + t2['losses']) if (t2['wins'] + t2['losses']) > 0 else 0
        
        return {
            "prob": prob,
            "diff": t1['rating'] - t2['rating'],
            "wr1": winrate_1,
            "wr2": winrate_2
        }

# --- –ò–ù–¢–ï–†–§–ï–ô–° ---
st.title("üõ°Ô∏è –ö–∏–±–µ—Ä—Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –ê–Ω–∞–ª–∏—Ç–∏–∫: Deep Analysis 2026")
st.markdown("---")

oracle = AdvancedOracle()
teams = oracle.get_pro_teams()

if teams:
    team_options = {f"{t['name']} ({t.get('tag', '???')})": t for t in teams[:250]}
    
    col_input1, col_input2 = st.columns(2)
    with col_input1:
        team_a_name = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–≤—É—é –∫–æ–º–∞–Ω–¥—É", list(team_options.keys()), index=0)
    with col_input2:
        team_b_name = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é –∫–æ–º–∞–Ω–¥—É", list(team_options.keys()), index=1)

    if st.button("üî• –ó–ê–ü–£–°–¢–ò–¢–¨ –ì–õ–£–ë–û–ö–ò–ô –ê–ù–ê–õ–ò–ó"):
        t1, t2 = team_options[team_a_name], team_options[team_b_name]
        data = oracle.get_detailed_prediction(t1, t2)
        
        # –í–∏–∑—É–∞–ª—å–Ω—ã–π –±–ª–æ–∫
        st.subheader(f"‚öîÔ∏è {t1['name']} vs {t2['name']}")
        c1, c2, c3 = st.columns(3)
        c1.metric("–®–∞–Ω—Å –ø–æ–±–µ–¥—ã", f"{data['prob']:.1%}")
        c2.metric("–†–∞–∑–Ω–∏—Ü–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞", f"{data['diff']:.0f}")
        c3.metric("–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ò–ò", "–í—ã—Å–æ–∫–∞—è" if abs(data['prob']-0.5) > 0.15 else "–°—Ä–µ–¥–Ω—è—è")
        
        st.divider()

        # –ì–õ–£–ë–û–ö–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê
        st.header("üìã –ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä –∞—Å–ø–µ–∫—Ç–æ–≤")
        
        tabs = st.tabs(["üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "üéÆ –°—Ç–∏–ª–∏—Å—Ç–∏–∫–∞", "üí∞ –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Å—Ç–∞–≤–æ–∫"])
        
        with tabs[0]:
            st.write(f"""
            * **–î–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ**: –ö–æ–º–∞–Ω–¥–∞ **{t1['name'] if data['diff'] > 0 else t2['name']}** –æ–ø–µ—Ä–µ–∂–∞–µ—Ç –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞ –Ω–∞ {abs(data['diff']):.0f} –ø—É–Ω–∫—Ç–æ–≤ Elo. –í 2026 –≥–æ–¥—É —Ç–∞–∫–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–µ –∫–∞—Ä—Ç—ã –Ω–∞ —Ä–∞–Ω–Ω–∏—Ö —Å—Ç–∞–¥–∏—è—Ö.
            * **–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –≤–∏–Ω—Ä–µ–π—Ç**: {t1['name']} ({data['wr1']:.1%}) –ø—Ä–æ—Ç–∏–≤ {t2['name']} ({data['wr2']:.1%}). –≠—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –æ–±—â—É—é —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ —Ç–µ–∫—É—â–µ–º —Å–µ–∑–æ–Ω–µ.
            """)

        with tabs[1]:
            st.write(f"""
            * **–ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –º–µ—Ç–µ**: –£—á–∏—Ç—ã–≤–∞—è —Ç–µ–∫—É—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥ ({max(t1['rating'], t2['rating']):.0f}), —Ñ–∞–≤–æ—Ä–∏—Ç –≤—Å—Ç—Ä–µ—á–∏ –ª—É—á—à–µ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ –ø–∞—Ç—á–∏ 2026 –≥–æ–¥–∞, –∏—Å–ø–æ–ª—å–∑—É—è –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —á–µ—Ä–µ–∑ –∞—É—Ä—É –∏ –±—ã—Å—Ç—Ä—ã–π –ø—É—à.
            * **–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç–æ—Ä**: –í –º–∞—Ç—á–∞—Ö —Ç–∞–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ –±–æ–ª–µ–µ 100 –ø—É–Ω–∫—Ç–æ–≤ —á–∞—Å—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ "–∑–∞–∂–∏–º–∞–Ω–∏—é" –∞—É—Ç—Å–∞–π–¥–µ—Ä–∞, —á—Ç–æ –¥–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å—Ç–∞–≤–∏—Ç—å –Ω–∞ **–ü–µ—Ä–≤—ã–µ 10 —É–±–∏–π—Å—Ç–≤** –≤ –ø–æ–ª—å–∑—É —Ñ–∞–≤–æ—Ä–∏—Ç–∞.
            """)

        with tabs[2]:
            st.info("–ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å—Ç–∞–≤–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è:")
            
            # –õ–æ–≥–∏–∫–∞ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è —Å—Ç–∞–≤–æ–∫
            if data['prob'] > 0.65:
                st.markdown(f"‚úÖ **–û—Å–Ω–æ–≤–Ω–æ–π –≤—ã–±–æ—Ä: –ü–æ–±–µ–¥–∞ {t1['name']} —Å —Ñ–æ—Ä–æ–π (-1.5)**")
                st.write(f"*–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ*: –†–∞–∑–Ω–∏—Ü–∞ –≤ –∫–ª–∞—Å—Å–µ –≤–µ–ª–∏–∫–∞. –§–∞–≤–æ—Ä–∏—Ç –∑–∞–∫—Ä–æ–µ—Ç —Å–µ—Ä–∏—é 2:0 —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –≤—ã—à–µ 60%.")
            elif data['prob'] < 0.35:
                st.markdown(f"‚úÖ **–û—Å–Ω–æ–≤–Ω–æ–π –≤—ã–±–æ—Ä: –ü–æ–±–µ–¥–∞ {t2['name']} —Å —Ñ–æ—Ä–æ–π (-1.5)**")
                st.write(f"*–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ*: {t2['name']} –Ω–∞ –≥–æ–ª–æ–≤—É –≤—ã—à–µ –ø–æ —Ç–µ–∫—É—â–∏–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º 2026 –≥–æ–¥–∞.")
            else:
                st.markdown("ü§ù **–û—Å–Ω–æ–≤–Ω–æ–π –≤—ã–±–æ—Ä: –¢–æ—Ç–∞–ª –∫–∞—Ä—Ç –ë–æ–ª—å—à–µ 2.5**")
                st.write(f"*–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ*: –ö–æ–º–∞–Ω–¥—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–ª–∏–∑–∫–∏ –ø–æ —Å–∏–ª–µ. –û–∂–∏–¥–∞–µ—Ç—Å—è –±–æ—Ä—å–±–∞ –Ω–∞ –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–µ –∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ BO3.")

            st.markdown("---")
            st.markdown("üî• **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: –ß–µ—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ—Ä–∞–≥–æ–≤ –Ω–∞ 1-–π –∫–∞—Ä—Ç–µ**")
            st.write("*–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ*: –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫ —Å –≤—ã—Å–æ–∫–æ–π –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å—é –¥–ª—è —Ä–∞–≤–Ω—ã—Ö –º–∞—Ç—á–µ–π.")

st.sidebar.warning("–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ OpenDota Pro API. –ü–æ–º–Ω–∏—Ç–µ, —á—Ç–æ –ò–ò –¥–∞–µ—Ç –ª–∏—à—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑.")